import{r as p,u as J,j as e,L as K,S as M,X as A,P as O,V as d}from"./index-tLwmzl-Q.js";import{v as P}from"./venteApi-CPDvCpwX.js";import{B as j}from"./Button-Lskl0WlK.js";import{u as U}from"./useQuery-BLmLD0fm.js";import{u as F}from"./useMutation-DIgAZNyt.js";const se=()=>{const r=JSON.parse(localStorage.getItem("user")||"{}")?.boutiqueId||null,[u,v]=p.useState([{stockId:"",quantite:0,prixApplique:0,nomProduit:""}]),[C,D]=p.useState({nom:"",adresse:""}),[l,N]=p.useState({bouteilleId:"",bouteilleText:"",huileId:"",huileText:"",alcoolId:"",alcoolText:"",montantTotal:0,taille:""}),[V,f]=p.useState(!1),[I,w]=p.useState(null),[L,g]=p.useState(!1),[c,S]=p.useState(null),[y,G]=p.useState(999999999),T=J(),{data:m=[],isLoading:z}=U({queryKey:["stocks-boutique",r],queryFn:async()=>{if(!r)return[];const t=await O.getPointVenteById(r);return D({nom:t.data?.nom||"",adresse:t.data?.adresse||""}),(t.data?.stocks||[]).filter(s=>s.status==="VALIDATED"&&s.quantity>0)},enabled:!!r}),q=F({mutationFn:P.createMultiple,onSuccess:()=>{T.invalidateQueries(["stocks-boutique",r]),d.success("Vente enregistrée avec succès"),v([{stockId:"",quantite:0,prixApplique:0,nomProduit:""}])},onError:t=>{const s=t?.response?.data?.message||t?.response?.data||t.message||"Erreur lors de l'enregistrement de la vente";d.error(s)}}),k=F({mutationFn:P.createProduitFini,onSuccess:()=>{T.invalidateQueries(["stocks-boutique",r]),d.success("Produit fini vendu avec succès"),N({bouteilleId:"",bouteilleText:"",huileId:"",huileText:"",alcoolId:"",alcoolText:"",taille:"",montantTotal:0}),g(!1),S(null)},onError:t=>{const s=t?.response?.data?.message||t?.response?.data||t.message||"Erreur lors de la vente du produit fini";d.error(s)}}),Q=t=>{if(t.preventDefault(),!r)return d.error("Boutique ID introuvable. Veuillez vous reconnecter.");for(const a of u){if(!a.stockId)return d.error("Veuillez sélectionner un produit.");if(a.quantite<=0)return d.error("Quantité invalide.");const i=m.find(b=>b.id===parseInt(a.stockId)),n=Math.min(i?.quantity||0,y);if(!i||a.quantite>n)return d.error(`Stock insuffisant ou quantité dépasse la limite autorisée pour le produit ${i?.produit?.name||""}.`)}const s=u.map(a=>{const n=m.find(b=>b.id===parseInt(a.stockId)).produit;return{id:n.id,reference:n.reference,name:n.name,price_buy:n.price_buy,price_sell:a.prixApplique,quantityStock:a.quantite}}),h=s.reduce((a,i)=>a+i.price_sell*i.quantityStock,0),o={boutique:{id:r,nom:C.nom,adresse:C.adresse},produits:s};w({venteData:o,totalMontant:h}),f(!0)},E=()=>{q.mutate(I.venteData,{onSuccess:()=>{f(!1),w(null)}})},$=()=>{if(!r)return d.error("Boutique ID introuvable. Veuillez vous reconnecter.");if(!l.bouteilleId||!l.huileId||!l.alcoolId||l.montantTotal<=0||!l.taille)return d.error("Veuillez remplir tous les champs du produit fini.");const t={boutiqueId:r,bouteilleId:parseInt(l.bouteilleId),taille:parseInt(l.taille),huileId:parseInt(l.huileId),alcoolId:parseInt(l.alcoolId),montantTotal:l.montantTotal};S(t),g(!0)},B=()=>{k.mutate(c)},_=()=>{v([...u,{stockId:"",quantite:0,prixApplique:0,nomProduit:""}])},R=t=>{const s=[...u];s.splice(t,1),v(s)},x=(t,s,h)=>{const o=[...u];o[t][s]=h,v(o)};return z?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(K,{size:"lg"})}):e.jsxs("div",{className:"space-y-10",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Enregistrer une vente "}),e.jsxs("form",{onSubmit:Q,className:"space-y-4 bg-white p-6 rounded-xl border",children:[e.jsx("h2",{className:"text-xl font-bold text-blue-700",children:"Vendre un ou plusieurs produits"}),u.map((t,s)=>{const o=m.find(i=>i.produit?.name.toLowerCase()===(t.nomProduit||"").toLowerCase())?.quantity||0,a=Math.min(o,y);return e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4 items-end border-b pb-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:"Nom du produit"}),e.jsx("input",{type:"text",placeholder:"Rechercher un produit",value:t.nomProduit||"",onChange:i=>{const n=i.target.value,b=m.find(H=>H.produit?.name.toLowerCase().includes(n.toLowerCase()));x(s,"nomProduit",n),x(s,"stockId",b?b.id:""),x(s,"prixApplique",b?.produit?.price_sell||0),x(s,"quantite",0)},list:`produits-list-${s}`,className:"w-full border p-2 rounded",required:!0}),e.jsx("datalist",{id:`produits-list-${s}`,children:m.map(i=>e.jsxs("option",{value:i.produit?.name,children:[i.produit?.name," — Qté: ",i.quantity]},i.id))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:"Quantité"}),e.jsx("input",{type:"number",min:"1",max:a,required:!0,value:t.quantite,onChange:i=>{const n=parseInt(i.target.value);isNaN(n)?x(s,"quantite",0):x(s,"quantite",n)},className:"w-full border p-2 rounded"}),t.quantite>a&&e.jsxs("p",{className:"text-sm text-red-600 mt-1",children:["Max: ",a]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:"Prix unitaire (MAD)"}),e.jsx("input",{type:"number",step:"0.01",min:"0",required:!0,value:t.prixApplique,onChange:i=>x(s,"prixApplique",parseFloat(i.target.value)||0),className:"w-full border p-2 rounded"})]}),u.length>1&&e.jsx("div",{className:"col-span-full flex justify-end",children:e.jsx("button",{type:"button",className:"text-red-500 text-sm",onClick:()=>R(s),children:"Supprimer"})})]},s)}),e.jsx("div",{children:e.jsx(j,{type:"button",onClick:_,className:"text-blue-600 text-sm",children:"+ Ajouter un autre produit"})}),e.jsxs(j,{type:"submit",className:"w-full bg-green-600 hover:bg-green-700",size:"lg",loading:q.isLoading,disabled:u.some(t=>!t.stockId||t.quantite<=0||t.quantite>Math.min(m.find(s=>s.id===parseInt(t.stockId))?.quantity||0,y)),children:[e.jsx(M,{className:"mr-2"}),"Enregistrer les ventes"]})]})]}),e.jsxs("div",{className:"space-y-4 bg-white p-6 rounded-xl border",children:[e.jsx("h2",{className:"text-xl font-bold text-blue-700",children:"Vendre un produit fini"}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:"Taille de la bouteille"}),e.jsxs("select",{value:l.taille,onChange:t=>N({...l,taille:t.target.value}),className:"w-full border p-2 rounded",required:!0,children:[e.jsx("option",{value:"",disabled:!0,children:"Choisir la taille"}),e.jsx("option",{value:20,children:"20"}),e.jsx("option",{value:30,children:"30"}),e.jsx("option",{value:50,children:"50"})]})]}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:["bouteille","huile","alcool"].map(t=>{const s=`${t}Id`,h=`${t}Text`;return e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium capitalize",children:t}),e.jsx("input",{type:"text",placeholder:`Rechercher un produit pour ${t}`,value:l[h],onChange:o=>{const a=o.target.value,i=m.find(n=>n.produit?.name.toLowerCase().includes(a.toLowerCase()));N(n=>({...n,[h]:a,[s]:i?i.produit?.id:""}))},list:`produits-list-${t}`,className:"w-full border p-2 rounded",required:!0}),e.jsx("datalist",{id:`produits-list-${t}`,children:m.map(o=>e.jsxs("option",{value:o.produit?.name,children:[o.produit?.name," — Stock: ",o.quantity]},o.id))})]},t)})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:"Montant total (MAD)"}),e.jsx("input",{type:"number",step:"0.01",min:"0",required:!0,value:l.montantTotal,onChange:t=>N({...l,montantTotal:parseFloat(t.target.value)||0}),className:"w-full border p-2 rounded"})]}),e.jsxs(j,{type:"button",className:"w-full bg-blue-600 hover:bg-blue-700",size:"lg",loading:k.isLoading,disabled:!l.bouteilleId||!l.huileId||!l.alcoolId||l.montantTotal<=0||!l.taille,onClick:$,children:[e.jsx(M,{className:"mr-2"}),"Vendre produit fini"]})]}),V&&I&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50",onClick:()=>f(!1),children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full shadow-lg relative",onClick:t=>t.stopPropagation(),children:[e.jsx("button",{onClick:()=>f(!1),className:"absolute top-3 right-3 text-gray-500 hover:text-gray-700","aria-label":"Close modal",children:e.jsx(A,{size:20})}),e.jsx("h2",{className:"text-xl font-bold mb-4",children:"Confirmer la vente"}),e.jsx("div",{className:"max-h-64 overflow-auto mb-4 border p-2 rounded",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left",children:"Produit"}),e.jsx("th",{className:"text-right",children:"Quantité"}),e.jsx("th",{className:"text-right",children:"Prix Unitaire (MAD)"}),e.jsx("th",{className:"text-right",children:"Total (MAD)"})]})}),e.jsx("tbody",{children:I.venteData.produits.map((t,s)=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{children:t.name}),e.jsx("td",{className:"text-right",children:t.quantityStock}),e.jsx("td",{className:"text-right",children:t.price_sell.toFixed(2)}),e.jsx("td",{className:"text-right",children:(t.price_sell*t.quantityStock).toFixed(2)})]},s))})]})}),e.jsxs("div",{className:"text-right font-semibold text-lg mb-4",children:["Montant Total: ",I.totalMontant.toFixed(2)," MAD"]}),e.jsxs("div",{className:"flex justify-end space-x-4",children:[e.jsx(j,{variant:"outline",onClick:()=>f(!1),children:"Annuler"}),e.jsx(j,{onClick:E,loading:q.isLoading,className:"bg-green-600 hover:bg-green-700",children:"Accepté"})]})]})}),L&&c&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50",onClick:()=>g(!1),children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full shadow-lg relative",onClick:t=>t.stopPropagation(),children:[e.jsx("button",{onClick:()=>g(!1),className:"absolute top-3 right-3 text-gray-500 hover:text-gray-700","aria-label":"Close modal",children:e.jsx(A,{size:20})}),e.jsx("h2",{className:"text-xl font-bold mb-4",children:"Confirmer la vente du produit fini"}),e.jsxs("div",{className:"mb-4 space-y-2",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Bouteille ID:"})," ",c.bouteilleId]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Huile ID:"})," ",c.huileId]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Alcool ID:"})," ",c.alcoolId]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Taille:"})," ",c.taille]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Montant Total:"})," ",c.montantTotal.toFixed(2)," MAD"]})]}),e.jsxs("div",{className:"flex justify-end space-x-4",children:[e.jsx(j,{variant:"outline",onClick:()=>g(!1),children:"Annuler"}),e.jsx(j,{onClick:B,loading:k.isLoading,className:"bg-blue-600 hover:bg-blue-700",disabled:!c.taille,children:"Accepté"})]})]})})]})};export{se as default};
