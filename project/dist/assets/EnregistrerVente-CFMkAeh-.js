import{r as m,u as J,j as e,S as w,X as F}from"./index-yrzGcrsz.js";import{v as A}from"./venteApi-BzG1DnF_.js";import{P as K}from"./PointsVenteApi-D-qlhskv.js";import{B as p}from"./Button-CeNaAo-j.js";import{L as O}from"./LoadingSpinner-xF3CygPc.js";import{V as l}from"./index-CyOt5fqF.js";import{u as R}from"./useQuery-CZB9O9Qr.js";import{u as M}from"./useMutation-DpsCt41A.js";import"./axiosInstance-Cz6MWCIH.js";const ne=()=>{const r=JSON.parse(localStorage.getItem("user")||"{}")?.boutiqueId||null,[d,g]=m.useState([{stockId:"",quantite:0,prixApplique:0}]),[y,P]=m.useState({nom:"",adresse:""}),[i,I]=m.useState({bouteilleId:"",huileId:"",alcoolId:"",montantTotal:0}),[T,h]=m.useState(!1),[j,k]=m.useState(null),[V,b]=m.useState(!1),[x,C]=m.useState(null),S=J(),{data:a=[],isLoading:D}=R({queryKey:["stocks-boutique",r],queryFn:async()=>{if(!r)return[];const t=await K.getPointVenteById(r);return P({nom:t.data?.nom||"",adresse:t.data?.adresse||""}),t.data?.stocks||[]},enabled:!!r}),N=M({mutationFn:A.createMultiple,onSuccess:()=>{S.invalidateQueries(["stocks-boutique",r]),l.success("Vente enregistrée avec succès"),g([{stockId:"",quantite:0,prixApplique:0}])},onError:t=>{const s=t?.response?.data?.message||t?.response?.data||t.message||"Erreur lors de l'enregistrement de la vente";l.error(s)}}),q=M({mutationFn:A.createProduitFini,onSuccess:()=>{S.invalidateQueries(["stocks-boutique",r]),l.success("Produit fini vendu avec succès"),I({bouteilleId:"",huileId:"",alcoolId:"",montantTotal:0}),b(!1),C(null)},onError:t=>{const s=t?.response?.data?.message||t?.response?.data||t.message||"Erreur lors de la vente du produit fini";l.error(s)}}),z=t=>{if(t.preventDefault(),!r)return l.error("Boutique ID introuvable. Veuillez vous reconnecter.");for(const n of d){if(!n.stockId)return l.error("Veuillez sélectionner un produit.");if(n.quantite<=0)return l.error("Quantité invalide.");const o=a.find(c=>c.id===parseInt(n.stockId));if(!o||n.quantite>o.quantity)return l.error(`Stock insuffisant pour le produit ${o?.produit?.name||""}.`)}const s=d.map(n=>{const c=a.find(H=>H.id===parseInt(n.stockId)).produit;return{id:c.id,reference:c.reference,name:c.name,price_buy:c.price_buy,price_sell:n.prixApplique,quantityStock:n.quantite}}),v=s.reduce((n,o)=>n+o.price_sell*o.quantityStock,0),u={boutique:{id:r,nom:y.nom,adresse:y.adresse},produits:s};k({venteData:u,totalMontant:v}),h(!0)},E=()=>{N.mutate(j.venteData,{onSuccess:()=>{h(!1),k(null)}})},Q=()=>{if(!r)return l.error("Boutique ID introuvable. Veuillez vous reconnecter.");if(!i.bouteilleId||!i.huileId||!i.alcoolId||i.montantTotal<=0)return l.error("Veuillez remplir tous les champs du produit fini.");const t={boutiqueId:r,bouteilleId:parseInt(i.bouteilleId),huileId:parseInt(i.huileId),alcoolId:parseInt(i.alcoolId),montantTotal:i.montantTotal};C(t),b(!0)},B=()=>{q.mutate(x)},L=()=>{g([...d,{stockId:"",quantite:0,prixApplique:0}])},_=t=>{const s=[...d];s.splice(t,1),g(s)},f=(t,s,v)=>{const u=[...d];u[t][s]=v,g(u)};return D?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx(O,{size:"lg"})}):e.jsxs("div",{className:"space-y-10",children:[e.jsxs("div",{className:"space-y-6",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Enregistrer une vente"}),e.jsxs("form",{onSubmit:z,className:"space-y-4 bg-white p-6 rounded-xl border",children:[e.jsx("h2",{className:"text-xl font-bold text-blue-700",children:"Vendre un ou plusieurs produits"}),d.map((t,s)=>{const u=a.find(n=>n.id===parseInt(t.stockId))?.quantity||0;return e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4 items-end border-b pb-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:"Produit"}),e.jsxs("select",{required:!0,value:t.stockId,onChange:n=>{const o=a.find(c=>c.id===parseInt(n.target.value));f(s,"stockId",n.target.value),f(s,"prixApplique",o?.produit?.price_sell||0),f(s,"quantite",0)},className:"w-full border p-2 rounded",children:[e.jsx("option",{value:"",children:"Sélectionnez un produit"}),a.map(n=>e.jsxs("option",{value:n.id,children:[n.produit?.name," — Qté: ",n.quantity]},n.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:"Quantité"}),e.jsx("input",{type:"number",min:"1",max:u,required:!0,value:t.quantite,onChange:n=>f(s,"quantite",parseFloat(n.target.value)||0),className:"w-full border p-2 rounded"}),t.quantite>u&&e.jsxs("p",{className:"text-sm text-red-600 mt-1",children:["Max: ",u]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:"Prix unitaire (MAD)"}),e.jsx("input",{type:"number",step:"0.01",min:"0",required:!0,value:t.prixApplique,onChange:n=>f(s,"prixApplique",parseFloat(n.target.value)||0),className:"w-full border p-2 rounded"})]}),d.length>1&&e.jsx("div",{className:"col-span-full flex justify-end",children:e.jsx("button",{type:"button",className:"text-red-500 text-sm",onClick:()=>_(s),children:"Supprimer"})})]},s)}),e.jsx("div",{children:e.jsx(p,{type:"button",onClick:L,className:"text-blue-600 text-sm",children:"+ Ajouter un autre produit"})}),e.jsxs(p,{type:"submit",className:"w-full bg-green-600 hover:bg-green-700",size:"lg",loading:N.isLoading,disabled:d.some(t=>!t.stockId||t.quantite<=0||t.quantite>(a.find(s=>s.id===parseInt(t.stockId))?.quantity||0)),children:[e.jsx(w,{className:"mr-2"}),"Enregistrer les ventes"]})]})]}),e.jsxs("div",{className:"space-y-4 bg-white p-6 rounded-xl border",children:[e.jsx("h2",{className:"text-xl font-bold text-blue-700",children:"Vendre un produit fini"}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:["bouteilleId","huileId","alcoolId"].map(t=>e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium capitalize",children:t.replace("Id","")}),e.jsxs("select",{required:!0,value:i[t],onChange:s=>I({...i,[t]:s.target.value}),className:"w-full border p-2 rounded",children:[e.jsx("option",{value:"",children:"Sélectionner un produit"}),a.map(s=>e.jsxs("option",{value:s.produit?.id,children:[s.produit?.name," — Stock: ",s.quantity]},s.id))]})]},t))}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium",children:"Montant total (MAD)"}),e.jsx("input",{type:"number",step:"0.01",min:"0",required:!0,value:i.montantTotal,onChange:t=>I({...i,montantTotal:parseFloat(t.target.value)||0}),className:"w-full border p-2 rounded"})]}),e.jsxs(p,{type:"button",className:"w-full bg-blue-600 hover:bg-blue-700",size:"lg",loading:q.isLoading,disabled:!i.bouteilleId||!i.huileId||!i.alcoolId||i.montantTotal<=0,onClick:Q,children:[e.jsx(w,{className:"mr-2"}),"Vendre produit fini"]})]}),T&&j&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50",onClick:()=>h(!1),children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full shadow-lg relative",onClick:t=>t.stopPropagation(),children:[e.jsx("button",{onClick:()=>h(!1),className:"absolute top-3 right-3 text-gray-500 hover:text-gray-700","aria-label":"Close modal",children:e.jsx(F,{size:20})}),e.jsx("h2",{className:"text-xl font-bold mb-4",children:"Confirmer la vente"}),e.jsx("div",{className:"max-h-64 overflow-auto mb-4 border p-2 rounded",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left",children:"Produit"}),e.jsx("th",{className:"text-right",children:"Quantité"}),e.jsx("th",{className:"text-right",children:"Prix Unitaire (MAD)"}),e.jsx("th",{className:"text-right",children:"Total (MAD)"})]})}),e.jsx("tbody",{children:j.venteData.produits.map((t,s)=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{children:t.name}),e.jsx("td",{className:"text-right",children:t.quantityStock}),e.jsx("td",{className:"text-right",children:t.price_sell.toFixed(2)}),e.jsx("td",{className:"text-right",children:(t.price_sell*t.quantityStock).toFixed(2)})]},s))})]})}),e.jsxs("div",{className:"text-right font-semibold text-lg mb-4",children:["Montant Total: ",j.totalMontant.toFixed(2)," MAD"]}),e.jsxs("div",{className:"flex justify-end space-x-4",children:[e.jsx(p,{variant:"outline",onClick:()=>h(!1),children:"Annuler"}),e.jsx(p,{onClick:E,loading:N.isLoading,className:"bg-green-600 hover:bg-green-700",children:"Accepté"})]})]})}),V&&x&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50",onClick:()=>b(!1),children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full shadow-lg relative",onClick:t=>t.stopPropagation(),children:[e.jsx("button",{onClick:()=>b(!1),className:"absolute top-3 right-3 text-gray-500 hover:text-gray-700","aria-label":"Close modal",children:e.jsx(F,{size:20})}),e.jsx("h2",{className:"text-xl font-bold mb-4",children:"Confirmer la vente du produit fini"}),e.jsxs("div",{className:"space-y-2 mb-4",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Bouteille:"})," ",a.find(t=>t.produit?.id===x.bouteilleId)?.produit?.name||"Inconnu"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Huile:"})," ",a.find(t=>t.produit?.id===x.huileId)?.produit?.name||"Inconnu"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Alcool:"})," ",a.find(t=>t.produit?.id===x.alcoolId)?.produit?.name||"Inconnu"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Montant Total:"})," ",x.montantTotal.toFixed(2)," MAD"]})]}),e.jsxs("div",{className:"flex justify-end space-x-4",children:[e.jsx(p,{variant:"outline",onClick:()=>b(!1),children:"Annuler"}),e.jsx(p,{onClick:B,loading:q.isLoading,className:"bg-green-600 hover:bg-green-700",children:"Accepté"})]})]})})]})};export{ne as default};
