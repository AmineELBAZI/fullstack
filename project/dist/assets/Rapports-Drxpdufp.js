import{r as g,j as e,L as M,a as S,B as E,P as R}from"./index-tLwmzl-Q.js";import{v as L}from"./venteApi-CPDvCpwX.js";import{p as B}from"./produitApi-rf_H1KRd.js";import{u as p}from"./useQuery-BLmLD0fm.js";import{D as C,C as F}from"./dollar-sign-C1jYiJ4H.js";import{T as K}from"./trending-up-ClodPRw7.js";function O(i){const o=new Date(i);return isNaN(o.getTime())?null:o.toISOString().split("T")[0]}const G=()=>{const[i,o]=g.useState({startDate:new Date(Date.now()-2592e6).toISOString().split("T")[0],endDate:new Date().toISOString().split("T")[0]}),{data:x=[],isLoading:b,isError:j}=p(["ventes"],()=>L.getAll().then(t=>t.data)),{data:m=[],isLoading:N,isError:y}=p(["produits"],()=>B.getAll().then(t=>t.data)),{data:f=[],isLoading:w,isError:v}=p(["boutiques"],()=>R.getAllPointsVente().then(t=>t.data)),A=b||N||w,D=j||y||v,a=g.useMemo(()=>{if(!x||!m||!f)return null;const t=x.map(s=>{const r=O(s.dateVente);return{...s,dateKey:r}}).filter(s=>s.dateKey&&s.dateKey>=i.startDate&&s.dateKey<=i.endDate&&s.boutique&&s.boutique.id),n=t.length,u=t.reduce((s,r)=>s+(r.montantTotal||0),0),V=n>0?u/n:0,l={},c={};t.forEach(s=>{if(!Array.isArray(s.produits))return;s.produits.forEach(d=>{d?.id&&(l[d.id]||(l[d.id]={quantite:0,chiffreAffaires:0}),l[d.id].quantite+=s.quantity||0,l[d.id].chiffreAffaires+=s.montantTotal||0)});const r=s.boutique?.id;r&&(c[r]||(c[r]={totalVentes:0,chiffreAffaires:0}),c[r].totalVentes+=1,c[r].chiffreAffaires+=s.montantTotal||0)});const q=Object.entries(l).map(([s,r])=>({nom:(m.find(h=>h.id===+s)||{}).name||"Produit inconnu",quantite:r.quantite,chiffreAffaires:r.chiffreAffaires})).sort((s,r)=>r.quantite-s.quantite).slice(0,5),P=Object.entries(c).map(([s,r])=>({nom:(f.find(h=>h.id===+s)||{}).nom||"Boutique inconnue",totalVentes:r.totalVentes,chiffreAffaires:r.chiffreAffaires})).sort((s,r)=>r.chiffreAffaires-s.chiffreAffaires).slice(0,5),T=t.filter(s=>s.dateVente&&!isNaN(new Date(s.dateVente))).sort((s,r)=>new Date(r.dateVente)-new Date(s.dateVente)).slice(0,10);return{chiffreAffaires:u,totalVentes:n,venteMoyenne:V,produitsVendus:t.reduce((s,r)=>s+(r.quantity||0),0),topProduits:q,topPointsVente:P,ventesRecentes:T}},[x,m,f,i]);return A?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx(M,{size:"lg"})}):D||!a?e.jsx("div",{className:"text-center text-red-600",children:"Une erreur est survenue lors du chargement des rapports."}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-6",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl  text-slate-900 font-bold  drop-shadow",children:"Rapports & Analyses"}),e.jsx("p",{className:"text-gray-500 mt-1 italic",children:"Vue d'ensemble des performances"})]})}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6",children:[{icon:e.jsx(C,{className:"h-6 w-6 text-blue-600"}),title:"Chiffre d'affaires",value:`${a.chiffreAffaires.toFixed(2)} MAD`},{icon:e.jsx(K,{className:"h-6 w-6 text-green-600"}),title:"Total des ventes",value:a.totalVentes},{icon:e.jsx(S,{className:"h-6 w-6 text-amber-600"}),title:"Produits vendus",value:a.produitsVendus},{icon:e.jsx(E,{className:"h-6 w-6 text-purple-600"}),title:"Vente moyenne",value:`${a.venteMoyenne.toFixed(2)} MAD`}].map((t,n)=>e.jsx("div",{className:"bg-white p-6 rounded-xl shadow-sm border",children:e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"p-2 bg-gray-50 rounded-lg",children:t.icon}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:t.title}),e.jsx("p",{className:"text-2xl font-bold",children:t.value})]})]})},n))}),e.jsxs("div",{className:"flex items-center gap-3 px-5 py-3 rounded-2xl shadow-lg border border-blue-100 bg-white/60 backdrop-blur-md",children:[e.jsxs("span",{className:"inline-flex items-center gap-2 text-blue-600 font-semibold",children:[e.jsx(F,{className:"h-5 w-5"}),e.jsx("span",{children:"Période :"})]}),e.jsx("input",{type:"date",value:i.startDate,onChange:t=>o({...i,startDate:t.target.value}),className:"rounded-lg border border-gray-300 px-3 py-1.5 focus:ring-2 focus:ring-blue-300 focus:border-blue-400 transition text-sm bg-white shadow-sm"}),e.jsx("span",{className:"mx-2 text-gray-400 font-bold text-lg",children:"→"}),e.jsx("input",{type:"date",value:i.endDate,onChange:t=>o({...i,endDate:t.target.value}),className:"rounded-lg border border-gray-300 px-3 py-1.5 focus:ring-2 focus:ring-blue-300 focus:border-blue-400 transition text-sm bg-white shadow-sm"})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"bg-white p-6 rounded-xl shadow-sm border",children:[e.jsx("div",{className:"flex justify-between mb-4",children:e.jsx("h1",{className:"text-2xl",children:"Produits les plus vendus"})}),e.jsx("div",{className:"space-y-3",children:a.topProduits.length?a.topProduits.map((t,n)=>e.jsxs("div",{className:"flex justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:t.nom}),e.jsxs("p",{className:"text-sm text-gray-500",children:[t.quantite," unités vendues"]})]}),e.jsxs("p",{className:"font-semibold text-green-600",children:[t.chiffreAffaires.toFixed(2)," MAD"]})]},n)):e.jsx("p",{className:"text-center text-gray-500",children:"Aucune donnée disponible"})})]}),e.jsxs("div",{className:"bg-white p-6 rounded-xl shadow-sm border",children:[e.jsx("div",{className:"flex justify-between mb-4",children:e.jsx("h3",{className:"text-2xl",children:"Points de vente performants"})}),e.jsx("div",{className:"space-y-3",children:a.topPointsVente.length?a.topPointsVente.map((t,n)=>e.jsxs("div",{className:"flex justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:t.nom}),e.jsxs("p",{className:"text-sm text-gray-500",children:[t.totalVentes," ventes"]})]}),e.jsxs("p",{className:"font-semibold text-blue-600",children:[t.chiffreAffaires.toFixed(2)," MAD"]})]},n)):e.jsx("p",{className:"text-center text-gray-500",children:"Aucune donnée disponible"})})]})]}),e.jsxs("div",{className:"bg-white p-6 rounded-xl shadow-sm border",children:[e.jsx("div",{className:"flex justify-between mb-4",children:e.jsx("h3",{className:"text-2xl",children:"Ventes récentes"})}),a.ventesRecentes.length?e.jsxs("table",{className:"min-w-full text-left border-collapse border border-gray-200",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-100",children:[e.jsx("th",{className:"border border-gray-300 p-2",children:"Date"}),e.jsx("th",{className:"border border-gray-300 p-2",children:"Boutique"}),e.jsx("th",{className:"border border-gray-300 p-2",children:"Montant total (MAD)"}),e.jsx("th",{className:"border border-gray-300 p-2",children:"Produits"})]})}),e.jsx("tbody",{children:a.ventesRecentes.map((t,n)=>e.jsxs("tr",{className:"even:bg-gray-50",children:[e.jsx("td",{className:"border border-gray-300 p-2",children:new Date(t.dateVente).toLocaleDateString()}),e.jsx("td",{className:"border border-gray-300 p-2",children:t.boutique?.nom||"N/A"}),e.jsx("td",{className:"border border-gray-300 p-2",children:(t.montantTotal||0).toFixed(2)}),e.jsx("td",{className:"border border-gray-300 p-2",children:Array.isArray(t.produits)&&t.produits.length>0?t.produits.map(u=>u.name||"Produit").join(", "):"Aucun produit"})]},n))})]}):e.jsx("p",{className:"text-center text-gray-500",children:"Aucune vente récente disponible"})]})]})};export{G as default};
