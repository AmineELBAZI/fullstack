import{r as d,u as T,j as e,L as P,S as h,B as Q,e as B,P as E}from"./index-tLwmzl-Q.js";import{v as u}from"./venteApi-CPDvCpwX.js";import{u as g}from"./useQuery-BLmLD0fm.js";import{u as j}from"./useMutation-DIgAZNyt.js";import{D as $,C as I}from"./dollar-sign-C1jYiJ4H.js";import{T as y}from"./trash-2-Bnbpo4Sm.js";const O=()=>{const[o,b]=d.useState(""),[c,N]=d.useState(""),[x,f]=d.useState(""),[r,n]=d.useState(new Set),p=T(),{data:w,isLoading:v,isError:S}=g({queryKey:["ventes"],queryFn:()=>u.getAll().then(s=>s.data)}),{data:D=[],isLoading:q}=g({queryKey:["points-vente"],queryFn:()=>E.getAllPointsVente().then(s=>s.data)}),i=j(s=>u.delete(s),{onSuccess:()=>{p.invalidateQueries(["ventes"]),n(new Set)},onError:s=>{alert("Erreur lors de la suppression: "+(s?.message||""))}}),m=j(s=>u.bulkDelete(Array.from(s)),{onSuccess:()=>{p.invalidateQueries(["ventes"]),n(new Set)},onError:s=>{alert("Erreur lors de la suppression multiple: "+(s?.message||""))}}),a=(w||[]).filter(s=>{const t=new Date(s.dateVente),l=c?t>=new Date(c):!0,F=x?t<=new Date(x):!0,L=o?s.boutique?.id===parseInt(o):!0;return l&&F&&L}).sort((s,t)=>new Date(t.dateVente)-new Date(s.dateVente)),C=a.length,V=a.reduce((s,t)=>s+(t.quantity||0),0),A=a.reduce((s,t)=>s+(t.montantTotal||0),0),k=s=>{n(t=>{const l=new Set(t);return l.has(s)?l.delete(s):l.add(s),l})},M=()=>{r.size===a.length?n(new Set):n(new Set(a.map(s=>s.id)))},z=()=>{r.size!==0&&window.confirm(`Voulez-vous vraiment supprimer ces ${r.size} ventes ?`)&&m.mutate(r)};return v||q?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx(P,{size:"lg"})}):S?e.jsx("div",{className:"text-center text-red-600 mt-8",children:"Une erreur est survenue lors du chargement des ventes."}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-6",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Liste des ventes"}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"bg-white shadow rounded-xl p-5 border border-gray-100 flex items-center space-x-4",children:[e.jsx("div",{className:"bg-blue-100 p-3 rounded-lg",children:e.jsx(h,{className:"h-6 w-6 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Nombre de ventes"}),e.jsx("p",{className:"text-xl font-bold text-gray-800",children:C})]})]}),e.jsxs("div",{className:"bg-white shadow rounded-xl p-5 border border-gray-100 flex items-center space-x-4",children:[e.jsx("div",{className:"bg-green-100 p-3 rounded-lg",children:e.jsx(Q,{className:"h-6 w-6 text-green-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Quantité totale vendue"}),e.jsx("p",{className:"text-xl font-bold text-gray-800",children:V})]})]}),e.jsxs("div",{className:"bg-white shadow rounded-xl p-5 border border-gray-100 flex items-center space-x-4",children:[e.jsx("div",{className:"bg-yellow-100 p-3 rounded-lg",children:e.jsx($,{className:"h-6 w-6 text-yellow-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500",children:"Chiffre d'affaires"}),e.jsxs("p",{className:"text-xl font-bold text-gray-800",children:[A.toFixed(2)," MAD"]})]})]})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow border border-gray-200 p-4 mb-6",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-end md:justify-between gap-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"inline-flex items-center gap-2 text-blue-600 font-semibold",children:[e.jsx(I,{className:"h-5 w-5"}),e.jsx("span",{children:"Période :"})]}),e.jsx("input",{type:"date",value:c,onChange:s=>N(s.target.value),className:"border border-gray-300 rounded-xl px-3 py-2"}),e.jsx("span",{className:"mx-1 text-gray-400 text-xl font-bold",children:"→"}),e.jsx("input",{type:"date",value:x,onChange:s=>f(s.target.value),className:"border border-gray-300 rounded-xl px-3 py-2"})]}),e.jsxs("div",{children:[e.jsxs("span",{className:"inline-flex items-center gap-2 text-blue-600 font-semibold",children:[e.jsx(B,{className:"h-5 w-5"}),e.jsx("span",{children:"  "})]}),e.jsxs("select",{value:o,onChange:s=>b(s.target.value),className:"border border-blue-800 bg-white rounded-xl px-3 py-2",children:[e.jsx("option",{value:"",children:"Tous les points de vente"}),D.map(s=>e.jsx("option",{value:s.id,children:s.nom},s.id))]})]})]}),e.jsxs("button",{onClick:z,disabled:m.isLoading||r.size===0,className:`px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700 transition ${r.size===0?"opacity-50 cursor-not-allowed":""}`,title:"Supprimer les ventes sélectionnées",children:["Supprimer la sélection (",r.size,")"]})]}),m.isLoading&&e.jsx("span",{className:"ml-3 text-red-600",children:"Suppression en cours..."})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden",children:[e.jsx("div",{className:"px-6 py-4 border-b border-gray-200 flex justify-between items-center",children:e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Historique des ventes"})}),e.jsx("div",{className:"overflow-x-auto hidden md:block",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3",children:e.jsx("input",{type:"checkbox",checked:r.size===a.length&&a.length>0,onChange:M,"aria-label":"Select all ventes"})}),e.jsx("th",{className:"px-6 py-3 text-left",children:"Produit"}),e.jsx("th",{className:"px-6 py-3 text-left",children:"Point de vente"}),e.jsx("th",{className:"px-6 py-3 text-left",children:"Quantité"}),e.jsx("th",{className:"px-6 py-3 text-left",children:"Prix unitaire"}),e.jsx("th",{className:"px-6 py-3 text-left",children:"Total"}),e.jsx("th",{className:"px-6 py-3 text-left",children:"Date"}),e.jsx("th",{className:"px-6 py-3 text-left",children:"Actions"})]})}),e.jsx("tbody",{children:a.map(s=>s.produits.map(t=>{const l=r.has(s.id);return e.jsxs("tr",{children:[e.jsx("td",{className:"px-6 py-4",children:e.jsx("input",{type:"checkbox",checked:l,onChange:()=>k(s.id),"aria-label":`Select vente ${s.id}`})}),e.jsx("td",{className:"px-6 py-4",children:t.name}),e.jsx("td",{className:"px-6 py-4",children:s.boutique?.nom||"—"}),e.jsx("td",{className:"px-6 py-4",children:s.produits.length===1?s.quantity:(s.quantity/s.produits.length).toFixed(2)}),e.jsxs("td",{className:"px-6 py-4",children:[(s.montantTotal/s.quantity).toFixed(2)," MAD"]}),e.jsxs("td",{className:"px-6 py-4 text-green-600 font-semibold",children:[(s.montantTotal/s.produits.length).toFixed(2)," MAD"]}),e.jsx("td",{className:"px-6 py-4",children:new Date(s.dateVente).toLocaleDateString("fr-FR")}),e.jsx("td",{className:"px-6 py-4",children:e.jsx("button",{onClick:()=>{window.confirm("Voulez-vous vraiment supprimer cette vente ?")&&i.mutate(s.id)},disabled:i.isLoading,className:"text-red-600 hover:text-red-800 transition-colors",title:"Supprimer la vente",children:e.jsx(y,{size:20})})})]},`${s.id}-${t.id}`)}))})]})}),e.jsx("div",{className:"md:hidden px-4 py-6",children:e.jsx("div",{className:"space-y-4 hide-scrollbar border-2 border-sky-500 rounded-md",style:{maxHeight:"70vh",overflowY:"auto"},children:a.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(h,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500",children:"Aucune vente trouvée"})]}):a.map(s=>s.produits.map(t=>e.jsxs("div",{className:"bg-gray-50 rounded-lg shadow-sm p-4 space-y-1 border",children:[e.jsx("p",{className:"font-semibold text-gray-800",children:t.name}),e.jsxs("p",{className:"text-sm text-gray-600",children:[e.jsx("span",{className:"font-medium",children:"Point de vente:"})," ",s.boutique?.nom||"—"]}),e.jsxs("p",{className:"text-sm text-gray-600",children:[e.jsx("span",{className:"font-medium",children:"Quantité:"})," ",s.produits.length===1?s.quantity:(s.quantity/s.produits.length).toFixed(2)]}),e.jsxs("p",{className:"text-sm text-gray-600",children:[e.jsx("span",{className:"font-medium",children:"Prix unitaire:"})," ",(s.montantTotal/s.quantity).toFixed(2)," MAD"]}),e.jsxs("p",{className:"text-sm text-green-600 font-semibold",children:[e.jsx("span",{className:"font-medium",children:"Total:"})," ",(s.montantTotal/s.produits.length).toFixed(2)," MAD"]}),e.jsxs("p",{className:"text-sm text-gray-500",children:[e.jsx("span",{className:"font-medium",children:"Date:"})," ",new Date(s.dateVente).toLocaleDateString("fr-FR")]}),e.jsx("button",{onClick:()=>{window.confirm("Voulez-vous vraiment supprimer cette vente ?")&&i.mutate(s.id)},disabled:i.isLoading,className:"text-red-600 hover:text-red-800 transition-colors mt-2",title:"Supprimer la vente",children:e.jsx(y,{size:20})})]},`${s.id}-${t.id}`)))})}),a.length===0&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(h,{className:"h-12 w-12 text-gray-400 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500",children:"Aucune vente trouvée"})]})]})]}),e.jsx("style",{children:`
          .hide-scrollbar::-webkit-scrollbar { display: none; }
          .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        `})]})};export{O as default};
